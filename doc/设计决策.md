## Grain管理

Silo启动后连接pd,定期向pd汇报健康状况。

当pd接收到Grain的查询请求时，如果发现Grain不存在，从健康的Silo中选择一个，将激活状态同步给选中的Silo。收到Silo的响应后将Silo地址返回给查询者。

查询者收到查询响应后将定位信息缓存在本地以后后续使用。之后将对Grain的请求发往Silo。

Silo接收到请求后，检查本地Grain信息，发现被请求的Grain在本地被激活，但尚未创建对象。于是在本地创建Grain对象，将请求交给它处理。

### Silo失联

当Silo失联一段时间之后，pd是否可以将其上激活的Grain回收。

如果Silo因为网络分区的原因跟pd失联一段时间后pd将其上激活的Grain回收，之后收到请求对于这批Grain的新的请求，pd选择在其它Silo上激活，这样将导致同一个Grain在不同的Silo上被创建。

这里的选择是一致性，当pd发现Silo不健康，向管理员发出警报，由管理员判断Silo是否发生故障。如果确认故障，手动从pd将Silo上的所有Grain回收。

### Grain的回收

Silo检测到Grain空闲一定时间后开始执行Grain回收流程。

1）标记Grain进入回收流程

2）销毁内存中的Grain对象

3）通告pd回收Grain

如果Grain进入回收流程后又收到请求，暂时将所有请求hold住，当流程完成之后，向所有这些请求通告路由信息失效。

### Silo接收到不存在的Grain的请求如何处理

发生的原因：

1. Silo崩溃后重启，其上的Grain被清除。
    
    处理方案：Silo启动后向pd获取本地激活的Grain信息。接收到Grain请求后如果发现Grain在本地激活但没有被创建，就把Grain创建出来。

2. Grain取消激活，某个节点的pd缓存落后了，将请求发往之前容纳Grain的Silo。
    
    处理方案：查询本地Grain信息，如果Grain不在本地激活，向对端通告pd信息不一致。



